name: Generate Ekaterinburg PMTiles

on:
  push:
    branches: [ "main", "master" ] # Запуск при пуше в основные ветки
  workflow_dispatch:              # Запуск вручную кнопкой
  schedule:
    - cron: '0 0 * * 1'           # Понедельник, 00:00

jobs:
  build:
    runs-on: ubuntu-latest
    # Используем готовый Docker-контейнер, чтобы не мучиться с зависимостями
    container: 
      image: ghcr.io/systemed/tilemaker:master

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare Configuration
        run: |
          # Если файлов конфигурации нет в репо, скачиваем дефолтные
          [ -f config-openmaptiles.json ] || curl -L -o config-openmaptiles.json https://raw.githubusercontent.com/systemed/tilemaker/master/resources/config-openmaptiles.json
          [ -f process-openmaptiles.lua ] || curl -L -o process-openmaptiles.lua https://raw.githubusercontent.com/systemed/tilemaker/master/resources/process-openmaptiles.lua

      - name: Download OSM Data
        run: |
          curl -L -o ekb.osm.pbf https://download.bbbike.org/osm/bbbike/Yekaterinburg/Yekaterinburg.osm.pbf

      - name: Generate PMTiles
        run: |
          tilemaker --input ekb.osm.pbf \
                    --output ekb.pmtiles \
                    --config config-openmaptiles.json \
                    --process process-openmaptiles.lua

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ekaterinburg-pmtiles
          path: ekb.pmtiles
          retention-days: 7 # Хранить файл неделю (чтобы не забивать место в GitHub)